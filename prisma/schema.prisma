generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ENUMS 
enum UserRole {
  CLIENT
  PROVIDER
  ADMIN
}

enum BookingStatus {
  PENDING_PAYMENT
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

// MODELS
model User {
  id                 Int      @id @default(autoincrement())
  email              String   @unique
  password           String
  name               String
  phone              String   @unique
  googleRefreshToken String?
  role               UserRole @default(CLIENT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - Se for CLIENT
  bookingsAsClient Booking[] @relation("ClientBookings")
  reviewsGiven     Review[]  @relation("ClientReviews")
  payments         Payment[]

  // Relations - Se for PROVIDER
  services           Service[]
  availabilities     Availability[]
  bookingsAsProvider Booking[]      @relation("ProviderBookings")
  reviews            Review[]       @relation("ProviderReviews")
  refreshTokens      RefreshToken[]

  @@map("users")
}

model Service {
  id          Int       @id @default(autoincrement())
  provider    User      @relation(fields: [providerId], references: [id], onDelete: Cascade)
  providerId  Int
  name        String
  description String?
  duration    Int // em minutos (15, 30, 45, 60, etc)
  price       Float // em reais
  category    String? // "Beleza", "Saúde", "Educação", etc
  isActive    Boolean   @default(true)
  bookings    Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("services")
}

model Availability {
  id         Int    @id @default(autoincrement())
  providerId Int
  dayOfWeek  Int // 0 = Domingo, 1 = Segunda, ..., 6 = Sábado
  startTime  String // "09:00"
  endTime    String // "18:00"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  provider User @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("availabilities")
}

model Booking {
  id                    Int           @id @default(autoincrement())
  startTime             DateTime
  endTime               DateTime
  providerGoogleEventId String?       @map("provider_google_event_id")
  clientGoogleEventId   String?       @map("client_google_event_id")
  status                BookingStatus @default(PENDING_PAYMENT)
  notes                 String?
  serviceId             Int
  clientId              Int
  providerId            Int

  // Stripe Integration
  paymentIntentId String? @unique

  // Timestamps
  paidAt      DateTime?
  cancelledAt DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  service  Service @relation(fields: [serviceId], references: [id])
  client   User    @relation("ClientBookings", fields: [clientId], references: [id])
  provider User    @relation("ProviderBookings", fields: [providerId], references: [id])

  payment Payment?
  review  Review?

  @@unique([providerId, startTime])
  @@map("bookings")
}

model Payment {
  id        Int           @id @default(autoincrement())
  amount    Float
  status    PaymentStatus @default(PENDING)
  bookingId Int           @unique
  userId    Int

  // Stripe
  paymentIntentId String  @unique
  paymentMethod   String? // "card", "pix", etc
  receiptUrl      String?

  // Refund
  refundId     String?
  refundAmount Float?
  refundedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@map("payments")
}

model Review {
  id         Int    @id @default(autoincrement())
  providerId Int
  clientId   Int
  bookingId  Int    @unique
  rating     Int // 1 a 5 estrelas
  comment    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  booking  Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  client   User    @relation("ClientReviews", fields: [clientId], references: [id])
  provider User    @relation("ProviderReviews", fields: [providerId], references: [id])

  @@map("reviews")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  expiresAt DateTime
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@map("refresh_tokens")
}
